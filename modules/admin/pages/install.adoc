:of: {of-sm}
:of-what: {of-sm}
:wt: solutionmanager

= Установка и настройка

// == Состав установочного комплекта

// . Пакет установки {of-sm}: `{dv} SolutionManager.msi`.
// . Пакет установки расширения Службы {ws} для {of-sm}: `{dv} Solution manager extension for Worker service.msi`.
// . `{dv} Solution manager.exe` -- пакетный установщик модулей _{sm}_, _Служба {ws}_ и _Расширение Службы {ws} для {of-sm}_.

// [#options]
// == Варианты установки {of-sm}
//
// .{sm} может быть установлен двумя способами:
// * Обычная установка.
// +
// Администратору нужно последовательно установить модули _{sm}_ и _Расширение Службы {ws} для {of-sm}_ из отдельных пакетов установки. Модуль "Служба {ws}" должен быть установлен заранее.
// +
// Данный вариант установки подходит для совместной и раздельной установки _{of-sm}_ и _Службы {ws}_.
// +
// * Установка с помощью пакетного установщика.
// +
// Пакетный установщик включает в себя установщики трех модулей: _{sm}_, _Служба {ws}_ и _Расширение Службы {ws} для {of-sm}_. Администратор может использовать пакетный установщик для установки всех компонентов, необходимых для работы {of-sm}.
// +
// Данный вариант установки подходит для совместной установки _{of-sm}_ и _Службы {ws}_.

Пользователь, выполняющий настройку {dv}, должен являться локальным администратором (быть указанным в файле sudoers).

[#linux]
== Установка на Linux

include::6.1@platform:admin:partial$install.adoc[]
+
Основные настройки, которые нужно сделать:
+
[source,json]
----
{
  "Urls": "http://+:5700",
  "Logging": {
    "LogLevel": { <.>
      "Default": "Warning"
    }
  },
  "AllowedHosts": "*",
  "SolutionManager": {
    "SettingsService": {
      "ConnectionString": "ConnectAddress=http://settings.domain.com:5200/api", <.>
      "ApiKey": "SettingsServiceApiKey" <.>
    },
    "StorageSettings": {
      "ConnectionString": "CONNECTION-STRING", <.>
      "CommandTimeOut": "300" <.>
    },
  },
  "Groups": {
    "Docsvision SolutionManager Administrators": [ <.>
     "account@domain.com" <.>
    ]
  },
  "NLog": {
    "targets": {
      "logFile": {
        "type": "File",
        "fileName": "${gdc:baseLogFolder}/docsvision/solutionmanager/${shortdate}_SolutionManager.log", <.>
        "layout": "[${longdate}][${level}][${callsite}] ${message} ${exception:format=tostring,Data}"
      }
    },
    "rules": [
      {
        "logger": "*",
        "minLevel": "Warn", <.>
        "writeTo": "logFile"
      }
    ]
  }
}
----
<.> `LogLevel` -- уровень ведения журнала.
<.> `ConnectionString` -- адрес {of-sett-serv}.
<.> `ApiKey` -- ключ доступа к Сервису настроек, указанный в xref:6.1@mgmtconsole:admin:install.adoc#sett-serv[конфигурационном файле] {of-sett-serv}.
<.> `ConnectionString` -- строка подключения базы данных МР, cм. подробнее <<conn-string,ниже>>.
<.> `CommandTimeOut` -- время ожидания перед завершением попытки выполнить операцию и созданием ошибки.
<.> `Docsvision SolutionManager Administrators` -- пользователи, которым разрешен вход в {sm}. Обратите внимание, что в группе массив строк, а не строка.
<.> `UserName` -- имя пользователя. Может быть указано в формате user@domain.com или domain\user.
<.> `fileName` -- путь к файлу журнала настраивается в параметре `\{gdc:baseLogFolder}`. По умолчанию используется каталог `/var/log/docsvision/solutionmanager`.
<.> `minLevel` -- уровень журналирования, по умолчанию используется `Warn`.
// end::linux[]
+
Дополнительная информация по настройке журналирования приведена https://nlog-project.org[на сайте] компонента NLog.
+
. Запустите службу модуля:
+
[source,bash]
----
sudo systemctl start dvsolutionmanager
----
+
. Выполните настройки для работы в домене, описанные в пункте <<domain,ниже>>. В противном случае аутентификация в модуле не будет доступна.
. Ознакомьтесь с разделом "xref:admin-functions.adoc[]", чтобы предоставить пользователям доступ к модулю, настроить путь к временной папке, изменить подключение к базе данных {of-sm} и выполнить другие действия.
. Ознакомьтесь с разделом "<<mgmt-console,Настройки в {of-mc}>>", чтобы выполнить необходимые для работы модуля настройки системы.

include::6.1@mgmtconsole:admin:install.adoc[tags=string]

[#domain]
== Настройка работы в домене

{mc} поддерживает работу в одном или нескольких доменах. Для этого в конфигурационном файле модуля необходимо выполнить настройку доменных каталогов -- параметр `"Catalogs"`.

В конфигурационном файле настройка представлена следующим массивом: `"Catalogs": []`. Настройки вступают в работу, если в массиве присутствует хотя бы одно описание каталога.

WARNING: Без выполнения данных настроек аутентификация в модуле будет недоступна!

[source,json]
----
 "Catalogs": [
  {
   "FullDomainName": "example1.com", <.>
    "NetBiosDomainName": "example1", <.>
    "LdapOptions": { <.>
      "LdapServerAddresses": [ "example1.com" ], <.>
      "AuthType": "Basic", <.>
      "Credential": { <.>
        "UserName": "user@example1.com",
        "Password": "Password" <.>
      }
    }
 },
  {
    "FullDomainName": "example2.com", <.>
    "ChallengeTo": "example1.com" <.>
  }
],
----
<.> `FullDomainName` -- полное имя домена указывается в формате `user@example.com` учётной записи после `@`.
<.> `NetBiosDomainName` -- `NetBios`-имя домена указывается в формате `domain\\user` перед `\\`.
<.> `LdapOptions` -- настройки подключения к LDAP каталогу домена.
<.> `LdapServerAddresses` -- адреса серверов LDAP данного домена. Если адрес соответствует полному имени домену, параметр можно удалить.
<.> `AuthType` -- тип аутентификации в LDAP.
<.> `Credential` -- логин и пароль пользователя для подключения к LDAP-каталогам текущего домена. Пароль для подключения можно зашифровать, см. подробнее в документации по установке системы, раздел "xref:install-linux:ROOT:appendix/account-protection.adoc[]".
<.> `UserName` -- имя пользователя. Может быть указано в формате user@domain.com или domain\user.
<.> `FullDomainName` -- полное имя домена указывается в формате `user@example.com` учётной записи после `@`.
<.> `ChallengeTo` -- настройка позволяет переадресовывать запросы от выбранного домена к каталогам указанного домена, см. <<challengeto,далее>>.

.Раздел `Catalogs` может содержать массив настроек вида:
[source,json]
----
 {
    "FullDomainName": "example.com", <.>
    "NetBiosDomainName": "EXAMPLE", <.>
    "LdapOptions": { <.>
      "LdapServerAddresses": [ "example.com" ], <.>
      "AuthType": "Basic", <.>
      "Port": 389, <.>
      "Credential": { <.>
        "UserName": "user@example.com", <.>
        "Password": "Password"
      }
    }
}
----
<.> `FullDomainName` -- полное имя домена указывается в формате `user@example.com` учётной записи после `@`.
<.> `NetBiosDomainName` -- `NetBios`-имя домена указывается в формате `domain\\user` перед `\\`.
<.> `LdapOptions` -- настройки подключения к LDAP каталогу домена.
<.> `LdapServerAddresses` -- адреса серверов LDAP данного домена. Если адрес соответствует полному имени домену, параметр можно удалить.
<.> `AuthType` -- тип аутентификации в LDAP.
<.> `Port` -- порт подключения к LDAP каталогам, перечисленным в `LdapServerAddresses`.
<.> `Credential` -- логин и пароль пользователя для подключения к LDAP-каталогам текущего домена. Пароль для подключения можно зашифровать, см. подробнее в документации по установке системы, раздел "xref:install-linux:ROOT:appendix/account-protection.adoc[]".
<.> `UserName` -- имя пользователя. Может быть указано в формате user@domain.com или domain\user.

include::6.1@platform:admin:config-domains.adoc[tags=chalto]

[#uninstall]
== Удаление модуля и расширения для Службы {ws}

_{sm}_ и _Расширение для Службы {ws}_ удаляются стандартным образом средствами ОС:

[source,bash,subs=attributes]
----
sudo apt-get purge docsvision-{wt}
----

// [WARNING]
// ====
// _Расширение для Службы {ws}_ может быть удалено только при установленном модуле _{dv} Служба {ws}_. Если удаляются оба модуля, расширение следует удалять перед удалением "Службы {ws}".
// ====

[#krb]
== Настройка аутентификации в Active Directory

. Настройте аутентификацию в Active Directory. Настройка потребуется для использования технологии единого входа (когда пользователь уже аутентифицирован в другом модуле системы). Для работы Kerberos аутентификации в ActiveDirectory, необходимо получить keytab-файл.
+
--
include::6.1@mgmtconsole:admin:provide-access.adoc[tags=keytab]
--

[#mgmt-console]
== Создание процесса для обработки задач {of-sm}

. После установки модуля _{sm}_ в {of-mc} автоматически появляется специальный тип конфигурации.
. В {of-mc} откройте вкладку "Служба {ws}" и подключите новый процесс. Подробнее см. "xref:6.1@mgmtconsole:user:worker-service.adoc[]".
+
// .Вкладка "Служба {ws}"
// image::worker-tab.png[Вкладка "Служба {ws}"]
+
. Нажмите на кнопку *Подключить процесс*.
. В появившемся окне введите _Имя процесса_ и выберите _Тип конфигурации_ *_{sm}_*.
. В настройках созданного процесса заполните обязательные поля:
+
* Таймаут -- поле необязательно для заполнения, подробнее см. в разделе "xref:6.1@mgmtconsole:user:worker-service.adoc#add[Добавить процесс]" документации модуля {mc}.
* Использовать x86 -- установите флаг, чтобы переключить обработку заданий на версию {of-ws} с указанной разрядностью. Когда флаг снят, используется разрядность x64.
+
WARNING: Несмотря на то, что настройки "Службы {ws}" с типом конфигурации "{sm}" создаются в {of-mc}, на страницах очереди входящих и исходящих сообщений не будут отображаться сообщения от {of-sm}. Очередь задач {of-sm} хранится в БД {of-sm} и Служба {ws} работает с ней напрямую.
// +
// . Если в процессе выполнения запроса возникла ошибка, она будет отображена в {of-mc}, на странице "xref:6.1@mgmtconsole:user:msg-outgoing.adoc[Очередь исходящих сообщений]".
